#!/usr/bin/env ruby
require 'json'
# A dmenu display customization script
# Assumes dmenu with q,xywh,xft patches
# http://github.com/mil/dmenu-q-xywh-xft

# Setup Screen Dimensions Info
xr = %x[xrandr | head -n1 | cut -d, -f2 | cut -d " " -f3-5].split(" x ")
$screen = {
  :width => xr[0].to_i,
  :height => xr[1].to_i
}

# Setup App Dimensions Info

# Defaults
$defaults = { 
  :h => 40,
  :x => 10,
  :y => ($screen[:height] / 2) - 20,
  :w => $screen[:width] - 20,
  :fn => 'Envy Code R-13',
  :sb => '#0073bf',
  :sf => '#ffffff',
  :nb => '#000000',
  :nf => '#c4c4c4',
  :p  => 'Rd Menu'
}

if (%x[pidof foo-wm].chomp! =~ /\d/) then

  f = %x[foo-wm-c /tmp/foo-wm.socket 'get focus'].chomp!
  if (f != "Foo" && JSON.parse(f)["type"] != "container") then 
    xwin = %x[xwininfo -id #{JSON.parse(f)["id"]}]
    font = ((xwin.match(/Width: (\d.+)$/)[1].to_i - 20 ) > 200) ? "Envy Code R-12" : "Terminus-9"

    $app = {
      :fn => font,
      :w => xwin.match(/Width: (\d.+)$/)[1].to_i - 20,
      :h=> (xwin.match(/Height: (\d.+)$/)[1].to_i / 11) - 1,
      :x => xwin.match(/Absolute.+X:  (\d(.+)?)$/)[1].to_i + 10,
      :y => xwin.match(/Absolute.+Y:  (\d(.+)?)$/)[1].to_i + 10,
      :l => "10"
    }

  else
    $app = $defaults
  end
else
    $app = $defaults

end

#Profiles
$profiles = {}
$profiles["launch"] = { :p => "Launch" }
$profiles["foowm"]  = $defaults.merge({
    :p => "Foo-WM",
    :sb => "#91ff00",
    :sf => "#000000"
})

# Password Prompt for pwdhashX
$profiles["domain"] = $app.merge({
  :p => "Domain",
  :sb => "#A2FF00",
  :fn => "Envy Code R-11",
  :sf => "#000000"
})

$profiles["password"] = $app.merge({
  :p => "Password",
  :nb => "#000000",
  :nf => "#000000",
  :fn => "Envy Code R-11",
})

$profiles["jump"] = {
  :p => "Jump",
  :fn => "Envy Code R-12",
  :sb => "#ffc400",
  :nf => "#ffffff",
  :sb => "#ffc400",
  :sf => "#000000"
}
$profiles["surfURI"] = $app.merge({
  :p => "Surf URI:"
})

$profiles["netcfg"] =  {
  :p => "Netcfg",
  :fn => "Envy Code R-11",
  :sb => "#ffc400",
  :nf => "#ffffff",
  :nb => "#000000",
  :sf => "#000000"
}

$profiles.merge({
  "surfSearch" =>  $app.merge({
    :p => "Surf Find:"
  }),
  "wifi" => { }
})

def dmenuOptsToString(optsHash)
  returnString = "dmenu "
  optsHash.each do |option, value|
    if (value.is_a? String)
      value = "'#{value}'"
    end
    returnString = "#{returnString} -#{option} #{value}"
  end

  return returnString
end

def main
  $stdout = STDERR
    if ($profiles[ARGV[0]] != nil) then
      $defaults.merge!($profiles[ARGV[0]])
    end

    dm = dmenuOptsToString($defaults) 
    $stdout = STDOUT
    $stdout.puts %x[#{dm}]
    %x[touch /tmp/bar-refresh]
end

main
