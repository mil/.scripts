#!/usr/bin/env ruby
require 'json'

def unicodeSymbol(unicodeNumber)
  return ""
  return %x[echo -ne "\\uE#{unicodeNumber}"]
end

class String
  def fg(i)
    return "\\f#{i}#{self}\\fr"
  end
  def bg(i)
    return "\\b#{i}#{self}\\br"
  end
end

count = 0
loop do
  # Battery
  batteryStatus = `battery status`.chomp!
  f = 3
  f = 4 if batteryStatus == "Charging"
  batteryStatus = " #{batteryStatus} ".fg(1).bg(2)
  batteryValue = " #{`battery percentage`.chomp!} ".fg(f)
  battery = "#{batteryStatus}#{batteryValue}"

  # Network
  networkLabel = " Network ".fg(1).bg(2)
  networkValue = " #{%x[netcfg current].chomp!} ".fg(5)
  network = "#{networkLabel}#{networkValue}"

  #Volume
  volumeLabel = " Volume ".fg(1).bg(2)
  volumeValue = " #{%x[amixer get Master | grep -woE '([0-9]+)\%' | head -1].chomp!} ".fg(6)
  volume = "#{volumeLabel}#{volumeValue}"


  time = Time.now.to_s.gsub!(/:\d{2}\s.+/, '').gsub!(/(\d{2}:\d{2})/, "\\f8| \\f4\\1")
  time = "\\fr\\br #{time}\\br\\fr"


  m = JSON %x[foo-wm-c "/tmp/stable-wm.socket" "get marks"]
  marks = m["marks"].join(" // \\f4".fg(4))

  marks = "\\f4\\b2 #{marks} \\br\\fr"


  #s = "\\u8#{wifi} #{battery} #{volume}\\c#{marks}\\r#{time} #{subway} #{weather}"
  active = "| urxvt - vim "
  s = "#{battery}#{network}#{volume}\\c#{time}\\r#{marks}#{active}"


  STDOUT.puts s
  STDOUT.flush

  count = count + 1
  if (count > 1) then
    sleep 20
  end
end
