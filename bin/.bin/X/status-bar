#!/usr/bin/env ruby
require 'pty'
require 'json'

$title = "X"
$date = "X"
$date_enabled = File.read('/home/mil/.date_enabled').chomp! == "true"


def refresh_bar
  date_markup = [ "<span fgcolor='#888888'>", $date, " </span>" ]
  title_markup = [ "<span bgcolor='#e8e8e8'> ", $title, " </span> " ]
  date_markup = [] if !$date_enabled

  STDOUT.puts "," + ([{
    :markup => 'pango',
    :full_text => (title_markup | date_markup).join("").gsub("\n", "")
  }]).to_json 
  STDOUT.flush
end

def poll_xtitle 
  cmd = "xtitle -s" 
  begin
    PTY.spawn( cmd ) do |stdout, stdin, pid|
      begin
        stdout.each { |line| 
          $title = line.chomp!
          refresh_bar
        }
      rescue Errno::EIO
        puts "Errno:EIO error, but this probably just means " +
              "that the process has finished giving output"
      end
    end
  rescue PTY::ChildExited
    puts "The child process exited!"
  end
end

def poll_date
  Thread.new {
    loop do
      $date = %x[date +"%I:%M%p"].chomp!
      refresh_bar
      sleep 60
    end
  }
end

def init_msg
  STDOUT.puts '{ "version": 1 }'
  STDOUT.puts "["
  STDOUT.puts "[]"
  STDOUT.flush
end

init_msg
poll_date
poll_xtitle
